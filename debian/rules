#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

CFLAGS = -Wall

PYVERS := $(shell pyversions -vr debian/control 2>/dev/null)

ifeq (,$(filter noopt,$(DEB_BUILD_OPTIONS)))
        CFLAGS += -O2
else
        CFLAGS += -O0
endif

ifeq ($(DEB_BUILD_ARCH),alpha)
        CFLAGS += -Wl,--no-relax
endif

ifeq ($(DEB_BUILD_ARCH),s390)
        CFLAGS += -gstabs
endif

ifneq (,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	NUMJOBS = $(patsubst parallel=%,%,$(filter parallel=%,$(DEB_BUILD_OPTIONS)))
	MAKEARGUMENTS += -j$(NUMJOBS)
endif

clean:
	dh_testdir
	dh_testroot

	rm -f build-stamp install-stamp
	rm -rf build-*
	rm -f WebKit/gtk/docs/version.xml
	rm -f GNUmakefile.in
	rm -f WebKit/dfb/docs/GNUmakefile.in
	rm -f WebKit/gtk/docs/GNUmakefile.in
	rm -f aclocal.m4
	rm -rf autom4te.cache/
	rm -f autotools/compile
	rm -f autotools/config.guess
	rm -f autotools/config.sub
	rm -f autotools/depcomp
	rm -f autotools/gtk-doc.m4
	rm -f autotools/install-sh
	rm -f autotools/libtool.m4
	rm -f autotools/ltmain.sh
	rm -f autotools/ltoptions.m4
	rm -f autotools/ltsugar.m4
	rm -f autotools/ltversion.m4
	rm -f autotools/lt~obsolete.m4
	rm -f autotools/missing
	rm -f autotoolsconfig.h.in
	rm -f config.log
	rm -f config.status
	rm -f configure
	rm -f doltcompile
	rm -f doltlibtool
	rm -f gtk-doc.make

	dh_clean

build: $(PYVERS:%=build-%/build-stamp)

build-%/build-stamp:
	dh_testdir

	[ ! -d build-$* ] && mkdir build-$* || true
	cd build-$* && \
	CFLAGS="$(CFLAGS)" \
	CXXFLAGS="$(CFLAGS)" \
	CC="gcc -Wl,--as-needed" \
	CXX="g++ -Wl,--as-needed" \
	PYTHON=`which python$*` ../autogen.sh --prefix=/usr \
		--host=$(DEB_HOST_GNU_TYPE) \
		--build=$(DEB_BUILD_GNU_TYPE) \
		--with-python-config=python$*-config \
		--enable-gtk-doc=no \
		--enable-debug=no

	$(MAKE) $(MAKEARGUMENTS) -C build-$*

	touch $@

install: $(PYVERS:%=install-%)

install-%: build-%/build-stamp
	dh_testdir
	dh_testroot

	dh_clean -k

	$(MAKE) -C build-$* install DESTDIR="$(CURDIR)"/debian/tmp
	#dh_install

	touch $@

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
	dh_installdocs -i
	dh_installchangelogs -i
	#dh_install -i #--sourcedir=debian/tmp
	dh_link -i
	dh_compress -i
	dh_fixperms -i
	dh_pysupport -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

# Build architecture-dependent files here.
binary-arch: build install
	dh_testdir
	dh_testroot
	dh_installdocs -a
	dh_installchangelogs -a
	dh_install -a --sourcedir=debian/tmp
	dh_link -a
	dh_strip -a #--dbg-package=libwebkitgtk-python-1.0-1-dbg
	dh_compress -a
	dh_fixperms -a
	dh_pysupport -a
	dh_makeshlibs -a -V 'libwebkitgtk-python-1.0-1 (>= 1.0.2)' -- -c4
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch

.PHONY: build clean install binary binary-indep binary-arch
